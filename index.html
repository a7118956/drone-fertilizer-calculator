<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>無人機施肥計算表（離線版）</title>
  <style>
    :root{
      --bg:#f7f9fb;
      --card:#ffffff;
      --grid:#cfd8e3;
      --head:#cfe3ff;
      --input:#ffe46b;
      --calc:#e6e6e6;
      --result:#2aa7b3;
      --text:#0f172a;
      --muted:#475569;
      --danger:#b91c1c;
      --blue:#1d4ed8;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .title{font-size:20px;font-weight:800;margin:6px 0 4px;}
    .sub{font-size:13px;color:var(--muted);line-height:1.45;margin:0 0 10px;}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:12px;overflow:hidden;box-shadow:0 1px 10px rgba(2,6,23,.05);}
    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    th,td{border:1px solid var(--grid);padding:10px 8px;vertical-align:middle;word-wrap:break-word;}
    th{background:var(--head);font-weight:800;text-align:center;}
    td.label{font-weight:700;}
    td.label.req{color:var(--blue);}
    td.value{text-align:center;font-variant-numeric:tabular-nums;}
    td.value input, td.value select{
      width:100%;box-sizing:border-box;
      font-size:16px;padding:10px 10px;border-radius:10px;
      border:1px solid #94a3b8;background:var(--input);
      outline:none;
    }
    td.value input:focus, td.value select:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15);}
    .calc{background:var(--calc);}
    .res{background:rgba(42,167,179,.18);font-weight:900;font-size:18px;}
    .small{font-size:12px;color:var(--muted);line-height:1.35;}
    .danger{color:var(--danger);font-weight:900;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 0;}
    button{
      border:1px solid var(--grid);background:white;border-radius:10px;
      padding:10px 12px;font-size:14px;font-weight:700;
    }
    button:active{transform:translateY(1px);}
    .pill{
      display:inline-block;padding:3px 8px;border-radius:999px;
      background:#e2e8f0;color:#0f172a;font-size:12px;font-weight:800;
    }
    .foot{font-size:12px;color:var(--muted);line-height:1.5;margin-top:10px;}
    @media (max-width:560px){
      th,td{padding:9px 6px;}
      td.value input, td.value select{font-size:16px;padding:10px 9px;}
      .res{font-size:17px;}
    }
  
/* === v2 UI polish (safe overlay; does not change IDs/logic) === */
.pill{display:inline-block;margin-left:8px;font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(29,78,216,.12);border:1px solid rgba(29,78,216,.25);color:var(--blue);}
.card{overflow-x:auto;}
table{min-width:720px;}
@media (max-width:820px){
  .wrap{padding:12px;}
  .title{font-size:18px;}
  td.value input, td.value select{font-size:16px;padding:12px 10px;}
  th,td{padding:10px 8px;}
}
/* Sticky header row for long scroll (best-effort) */
thead th{position:sticky;top:0;z-index:2;}
/* Dark mode */
/* 請找到原始碼中的這一段 @media (prefers-color-scheme: dark) 並替換成下方內容 */

@media (prefers-color-scheme: dark){
  :root{
    --bg: #0b1220;
    --card: #1e293b; /*稍微調亮卡片背景，增加層次感*/
    --grid: rgba(148,163,184,.2);
    --head: rgba(59,130,246,.15);
    
    /* 修改點 1: 夜間模式的輸入框黃色稍微暗一點，保護眼睛，但仍保持黃色識別度 */
    --input: #e6c200; 
    
    --calc: rgba(255,255,255,.05);
    --result: #38bdf8;
    --text: #f1f5f9;
    --muted: #94a3b8;
    --danger: #ff7b7b;
    --blue: #60a5fa;
  }
  
  /* 修改點 2: 修正按鈕在深色模式的視認性 */
  button {
    background: #334155; 
    border-color: #475569; 
    color: #f8fafc;
  }
  button.primary { background: rgba(56,189,248,.2); }

  /* 修改點 3 (最重要): 強制輸入框文字為深黑色 */
  /* 因為背景是黃色，不管日夜間，字體都必須是深色才看得到 */
  td.value input, td.value select {
    color: #0f172a !important; /* 強制深藍黑色 */
    border-color: #4b5563;     /* 邊框顏色 */
  }
  
  /* 修正 iOS Safari 下拉選單在夜間可能變黑底白字的問題 */
  select {
    -webkit-appearance: none; /* 移除 iOS 預設樣式 */
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right .7em top 50%;
    background-size: .65em auto;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">無人機施肥計算表（離線版 / iPhone 可加入主畫面） <span class="pill">v2</span></div>
  <p class="sub">
    藍色欄位名稱＝必填輸入；所有計算結果會即時更新。<br>
    <b>模式建議：</b>若現場流量/顆粒狀態變動大、暫時無法校正，預設用 <b>追總量</b> 較能確保「總公斤數」達標；但可能犧牲「每分均勻度」。若你已完成流量校正、追求均勻施用，改用 <b>按標準</b> 較穩。
  </p>

  <div class="card">
    <table>
      <colgroup>
        <col style="width:34%">
        <col style="width:16%">
        <col style="width:34%">
        <col style="width:16%">
      </colgroup>
      <tr>
        <th>欄位名稱1</th>
        <th>公式1</th>
        <th>欄位名稱2</th>
        <th>公式2</th>
      </tr>

      <tr>
        <td class="label req">* 地塊面積（畝）</td>
        <td class="value"><input id="B4" type="number" step="0.01" value="14.42"></td>
        <td class="label">地塊面積（畝換算分）</td>
        <td class="value calc" id="D4"></td>
      </tr>
      <tr>
        <td class="label req">* 作業面積（畝）</td>
        <td class="value"><input id="B5" type="number" step="0.01" value="12.8"></td>
        <td class="label">作業面積（畝換算分）</td>
        <td class="value calc" id="D5"></td>
      </tr>

      <tr>
        <td class="label req">* 一甲地需要下幾包肥？</td>
        <td class="value"><input id="B7" type="number" step="1" value="10"></td>
        <td class="label req">* 每包肥料重量(公斤)？</td>
        <td class="value"><input id="D7" type="number" step="0.1" value="3"></td>
      </tr>
      <tr>
        <td class="label req">* 額外加肥重量（公斤）</td>
        <td class="value"><input id="B8" type="number" step="0.1" value="0"></td>
        <td class="label"></td>
        <td class="value calc"></td>
      </tr>
      <tr>
        <td class="label req">* 每分地施肥用量（公斤）</td>
        <td class="value"><input id="B9" type="number" step="0.01" value="3"></td>
        <td class="label"></td>
        <td class="value calc"></td>
      </tr>

      <tr>
        <td class="label req">* 肥料種類</td>
        <td class="value">
          <select id="FERT" style="width:100%;box-sizing:border-box;font-size:16px;padding:10px 10px;border-radius:10px;border:1px solid #94a3b8;background:var(--input);">
            <option value="複合肥">複合肥</option>
			<option value="尿素">尿素</option>
			<option value="複合肥+尿素">複合肥+尿素</option>
			<option value="除田草" selected>除田草</option>
            <option value="玉米碎粒" selected>福壽螺藥</option>
            <option value="其他">其他（自行輸入）</option>
          </select>
          <input id="FERT_OTHER" type="text" placeholder="若選其他，請輸入" style="margin-top:8px;display:none;width:100%;box-sizing:border-box;font-size:16px;padding:10px 10px;border-radius:10px;border:1px solid #94a3b8;background:white;">
        </td>
        <td class="label"><div class="small">用來記錄顆粒粗細/含水等差異，方便日後比對同一肥料在不同天氣的畝用量表現。</div></td>
        <td class="value calc" id="FERT_SHOW"></td>
      </tr>


      <tr>
        <td class="label">施肥總公斤數（公斤）</td>
        <td class="value res" id="B10"></td>
        <td class="label">需要肥料包數？</td>
        <td class="value calc" id="D10"></td>
      </tr>
      <tr>
        <td class="label"></td>
        <td class="value calc"></td>
        <td class="label"></td>
        <td class="value calc" id="D11"></td>
      </tr>

      <tr>
        <td class="label">播撒畝用量（公斤/畝）</td>
        <td class="value res" id="B12"></td>
        <td class="label req">* 模式選擇</td>
        <td class="value">
          <select id="D12">
            <option value="追總量" selected>追總量</option>
            <option value="按標準">按標準</option>
          </select>
        </td>
      </tr>

      <tr>
        <td class="label">公式預估畝用量值是否有差距（手動輸入）</td>
        <td class="value calc"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>
      <tr>
        <td class="label req">* 人工手動微調 畝用量(預測)</td>
        <td class="value"><input id="B15" type="number" step="0.01" value="2.32"></td>
        <td class="label">
          <div class="small">
            系統自動預測 施肥總公斤數（只加不減，MAX(0, B15-B12)）<br>
            （每 +0.1 畝用量，總量約 +1.35kg；每 +1 約 +13.46kg；斜率可調）
          </div>
        </td>
        <td class="value calc" id="D15"></td>
      </tr>
      <tr>
        <td class="label req">* 斜率（每 +1 畝用量，總量增加kg）</td>
        <td class="value"><input id="B16" type="number" step="0.01" value="13.46"></td>
        <td class="label"><div class="small">系統自動預測 施肥總公斤數 2（可正可負）</div></td>
        <td class="value calc" id="D16"></td>
      </tr>

      <tr>
        <td class="label"><b>飛行確認書（須由飛手人員手動輸入）</b></td>
        <td class="value calc"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>
      <tr>
        <td class="label"><b>實際施肥數據計算</b></td>
        <td class="value calc"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>

      <tr>
        <td class="label req">* 本次作業面積（畝）</td>
        <td class="value"><input id="B19" type="number" step="0.01" value="7.21"></td>
        <td class="label">本次作業面積（畝換算分）</td>
        <td class="value calc" id="D19"></td>
      </tr>
      <tr>
        <td class="label req">* 本次用料量（千克）</td>
        <td class="value"><input id="B20" type="number" step="0.01" value="16.3"></td>
        <td class="label">本次作業計畫應播撒用量（千克）</td>
        <td class="value calc" id="D20"></td>
      </tr>

      <tr>
        <td class="label req">* 已作業面積（畝）</td>
        <td class="value"><input id="B22" type="number" step="0.01" value="7.21"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>
      <tr>
        <td class="label req">* 已播撒用料量（千克）</td>
        <td class="value"><input id="B23" type="number" step="0.01" value="16.3"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>

      <tr>
        <td class="label">推算本次作業的畝用量</td>
        <td class="value calc" id="B25"></td>
        <td class="label">此次作業，肥料誤差值（公斤）</td>
        <td class="value calc" id="D25"></td>
      </tr>

      <tr>
        <td class="label">播撒畝用量(B12)</td>
        <td class="value calc" id="B26"></td>
        <td class="label">此次作業，畝用量誤差值（公斤/畝）</td>
        <td class="value calc" id="D26"></td>
      </tr>
      <tr>
        <td class="label"></td>
        <td class="value calc"></td>
        <td class="label">此次作業，畝用量誤差值（公斤/分）</td>
        <td class="value calc" id="D27"></td>
      </tr>

      <tr>
        <td class="label"><b>還需作業面積（畝）</b></td>
        <td class="value calc"></td>
        <td class="label calc"></td>
        <td class="value calc"></td>
      </tr>

      <tr>
        <td class="label">尚需作業面積（畝）</td>
        <td class="value calc" id="B34"></td>
        <td class="label">尚需作業面積（分）</td>
        <td class="value calc" id="D34"></td>
      </tr>
      <tr>
        <td class="label">尚需播撒用料量（千克）</td>
        <td class="value calc" id="B35"></td>
        <td class="label">尚需肥料包數（包）</td>
        <td class="value calc" id="D35"></td>
      </tr>
      <tr>
        <td class="label">自動計算下次建議使用的畝用量（依模式）</td>
        <td class="value res" id="B36"></td>
        <td class="label">
          <div class="small">剩餘作業面積施肥標準需求用量(公斤)：尚需作業面積(B34) × 0.687 × 每分地施肥用量(B9)</div>
        </td>
        <td class="value calc" id="D36"></td>
      </tr>
      <tr>
        <td class="label"><b>目前模式下剩餘應撒公斤數</b></td>
        <td class="value res" id="B37"></td>
        <td class="label">目前模式下剩餘肥料包數</td>
        <td class="value calc" id="D37"></td>
      </tr>

      <tr>
        <td class="label">自動計算最佳畝用量</td>
        <td class="value calc" id="B39"></td>
        <td class="label">系統自動預測施肥總公斤數（作業面積×最佳畝用量）</td>
        <td class="value calc" id="D39"></td>
      </tr>
    </table>
  </div>

  
  <div class="card" style="margin-top:12px;">
    <div style="padding:12px 12px 10px;border-bottom:1px solid var(--grid);background:#f1f5f9;">
      <div style="font-weight:900;">常用設定（本機儲存）</div>
      <div class="small">可把目前輸入值（含模式、面積、每分用量、每包重量、已作業/已用量等）存成「預設」，之後一鍵載入。資料保存在 iPhone 本機（Safari/主畫面 App）內，不會上傳。</div>
    </div>
    <div style="padding:12px;">
      <div style="display:grid;grid-template-columns:1.2fr 0.8fr;gap:10px;align-items:end;">
        <div>
          <div class="small" style="margin-bottom:6px;font-weight:800;color:var(--muted);">選擇預設</div>
          <select id="presetSelect" style="width:100%;font-size:16px;padding:10px 10px;border-radius:10px;border:1px solid #94a3b8;background:white;">
          </select>
        </div>
        <div>
          <div class="small" style="margin-bottom:6px;font-weight:800;color:var(--muted);">新預設名稱（可選）</div>
          <input id="presetName" type="text" placeholder="例如：玉米田A / 除田草細粒" style="width:100%;box-sizing:border-box;font-size:16px;padding:10px 10px;border-radius:10px;border:1px solid #94a3b8;background:white;">
        </div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button id="btnLoadPreset">載入</button>
        <button id="btnSavePreset">儲存（覆蓋/新增）</button>
        <button id="btnDeletePreset">刪除</button>
        <button id="btnExportPreset">匯出（複製 JSON）</button>
        <button id="btnImportPreset">匯入（貼上 JSON）</button>
        <button id="btnQuickSavePlot">一鍵存目前地塊</button>
        <button id="btnLoadLast">載入上次設定</button>
        <button id="btnExportFile">備份到檔案</button>
        <label style="display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--grid);border-radius:10px;background:#fff;">
          <input id="autoLoadLast" type="checkbox" checked style="width:18px;height:18px;">
          <span style="font-size:13px;font-weight:800;">開啟時自動載入上次設定</span>
        </label>
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </div>

      <div class="small" style="margin-top:8px;">
        小提醒：如果你用「加入主畫面」開啟，這些預設會跟著主畫面 App 保留；清除 Safari 網站資料可能會讓預設消失。
      </div>

      <div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--grid);">
        <div style="font-weight:900;margin-bottom:6px;">肥料種類清單（可自訂）</div>
        <div class="small">你可以把常用肥料名稱加入清單（例如：除田草(細)、除田草(粗)、硫酸銨、石灰氮…）。清單會保存在本機，可備份到檔案。</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px;">
          <input id="fertListAdd" type="text" placeholder="輸入肥料名稱後加入" style="flex:1;min-width:220px;box-sizing:border-box;font-size:16px;padding:10px 10px;border-radius:10px;border:1px solid #94a3b8;background:white;">
          <button id="btnAddFert">加入</button>
          <button id="btnRemoveFert">移除目前選取</button>
          <button id="btnResetFert">重設為預設清單</button>
        </div>
      </div>

    </div>
  </div>


  <div class="btns">
    <button id="btnReset">重設為範例值</button>
    <button id="btnCopy">複製摘要（剪貼簿）</button>
  </div>

  <div class="foot"><b>重要：</b>如果你在 iPhone「設定 → Safari → 清除瀏覽資料/網站資料」，本機預設仍可能被清掉。為了確保不丟資料，請定期用上方「備份到檔案」把預設備份到「檔案/iCloud」，需要時再匯入。
<br><br>
    <b>加入主畫面：</b>iPhone Safari 打開此檔 → 分享 →「加入主畫面」。<br>
    <b>離線使用：</b>此檔案可直接存在「檔案App」中開啟；若要完全像 App（含快取離線），可再加 service worker（需要部署到 https 網址）。
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // Excel-like helpers
  function toNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function round(n, d){
    const f = Math.pow(10, d);
    return Math.round((n + Number.EPSILON) * f) / f;
  }
  function mod(n, m){
    if(m===0) return 0;
    return ((n % m) + m) % m;
  }
  function fmt(n, d=2){
    if(!Number.isFinite(n)) return "0";
    return round(n, d).toFixed(d).replace(/\.00$/,'');
  }
  function bagsText(kg, bagKg){
    if(bagKg<=0) return "錯誤";
    const bags = Math.floor(kg / bagKg);
    const rest = round(mod(kg, bagKg), 1);
    return `${bags} 包 + ${rest} 公斤`;
  }

  // === Inputs list (MUST be defined before any preset/localStorage code uses it) ===
  const inputs = ["B4","B5","B7","D7","B8","B9","D12","B15","B16","B19","B20","B22","B23", "FERT", "FERT_OTHER"];

  // Defaults
  const defaults = {
    B4: 14.42, B5: 12.8, B7: 10, D7: 3, B8: 0, B9: 3,
    D12: "追總量", B15: 2.32, B16: 13.46,
    B19: 7.21, B20: 16.3, B22: 7.21, B23: 16.3,
    FERT: "除田草", FERT_OTHER: "", autoLoadLast: true
  };

  // ===== 常用設定（Presets / localStorage） =====
  const LS_KEY = "fertcalc_presets_v1";
  const LS_FERT = "fertcalc_fertlist_v1";
  const LS_LAST = "fertcalc_last_v1";

  function getAllInputs(){
    const obj = {};
    inputs.forEach(id=>{
      const el = $(id);
      if(!el) return;
      if(el.tagName==="SELECT") obj[id] = el.value;
      else obj[id] = el.value; // keep as string; compute() will parse numbers
    });
    obj["autoLoadLast"] = $("autoLoadLast") ? !!$("autoLoadLast").checked : true;
    return obj;
  }

  function applyInputs(obj){
    inputs.forEach(id=>{
      if(!(id in obj)) return;
      const el = $(id);
      if(!el) return;
      el.value = obj[id];
    });
    if($("autoLoadLast") && ("autoLoadLast" in obj)) $("autoLoadLast").checked = !!obj.autoLoadLast;
  }

  function loadPresets(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return {};
      const data = JSON.parse(raw);
      if(typeof data !== "object" || data===null) return {};
      return data;
    }catch(e){
      return {};
    }
  }
  function savePresets(presets){
    localStorage.setItem(LS_KEY, JSON.stringify(presets));
  }

  function loadFertList(){
    try{
      const raw = localStorage.getItem(LS_FERT);
      if(!raw) return null;
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : null;
    }catch(e){ return null; }
  }
  function saveFertList(arr){
    localStorage.setItem(LS_FERT, JSON.stringify(arr));
  }
  function defaultFertList(){
    return ["複合肥","尿素","除田草","玉米碎粒","福壽螺藥","其他"];
  }
  function ensureFertList(){
    const cur = loadFertList();
    if(cur && cur.length) return cur;
    const base = defaultFertList();
    saveFertList(base);
    return base;
  }
  function refreshFertSelect(){
    const sel = $("FERT");
    if(!sel) return;
    const list = ensureFertList();
    const current = sel.value;
    sel.innerHTML = "";
    list.forEach(name=>{
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
    if(list.includes(current)) sel.value = current;
    else sel.value = list[0] || "其他";
    if($("FERT_OTHER")) $("FERT_OTHER").style.display = (sel.value==="其他") ? "block" : "none";
  }

  function refreshPresetSelect(selectedKey=null){
    const sel = $("presetSelect");
    if(!sel) return;
    const presets = loadPresets();
    const keys = Object.keys(presets).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
    sel.innerHTML = "";
    if(keys.length===0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "（尚無預設，請先儲存）";
      sel.appendChild(opt);
      sel.value = "";
      return;
    }
    keys.forEach(k=>{
      const item = presets[k];
      const meta = (item && item.meta) ? item.meta : {};
      const last = meta.last_used ? new Date(meta.last_used) : null;
      const lastStr = last ? `${last.getMonth()+1}/${last.getDate()} ${String(last.getHours()).padStart(2,"0")}:${String(last.getMinutes()).padStart(2,"0")}` : "未使用";
      const cnt = (meta.use_count ?? 0);
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = `${k} 〔最近：${lastStr}｜次數：${cnt}〕`;
      sel.appendChild(opt);
    });
    sel.value = (selectedKey && presets[selectedKey]) ? selectedKey : keys[0];
  }

  function ensureDefaultPresets(){
    const presets = loadPresets();
    if(Object.keys(presets).length>0) return;
    const now = new Date().toISOString();
    presets["預設-追總量（建議）"] = {data:{...defaults, D12:"追總量"}, meta:{created_at:now, last_used:null, use_count:0}};
    presets["預設-按標準（校正後）"] = {data:{...defaults, D12:"按標準"}, meta:{created_at:now, last_used:null, use_count:0}};
    savePresets(presets);
  }

  function saveLast(){
    try{
      localStorage.setItem(LS_LAST, JSON.stringify(getAllInputs()));
    }catch(e){}
  }

  function loadLastIfAny(){
    try{
      const raw = localStorage.getItem(LS_LAST);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(typeof obj!=="object" || obj===null) return false;
      applyInputs(obj);
      return true;
    }catch(e){
      return false;
    }
  }

  function makeTimestampKey(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  }

  function getFertName(){
    const sel = $("FERT") ? $("FERT").value : "";
    if(sel==="其他"){
      const other = ($("FERT_OTHER")?.value || "").trim();
      return other ? other : "其他";
    }
    return sel || "未指定";
  }

  function setInputs(obj){
    for(const [k,v] of Object.entries(obj)){
      const el = $(k);
      if(!el) continue;
      el.value = v;
    }
    if($("autoLoadLast") && ("autoLoadLast" in obj)) $("autoLoadLast").checked = !!obj.autoLoadLast;
  }

  function compute(){
    const B4 = toNum($("B4").value);
    const B5 = toNum($("B5").value);
    const B7 = toNum($("B7").value);
    const D7 = toNum($("D7").value);
    const B8 = toNum($("B8").value);
    const B9 = toNum($("B9").value);

    const mode = $("D12").value;
    const B15 = toNum($("B15").value);
    const B16 = toNum($("B16").value);

    const B19 = toNum($("B19").value);
    const B20 = toNum($("B20").value);
    const B22 = toNum($("B22").value);
    const B23 = toNum($("B23").value);

    if($("FERT") && $("FERT_OTHER")){
      $("FERT_OTHER").style.display = ($("FERT").value==="其他") ? "block" : "none";
    }
    const fertName = getFertName();

    const D4 = round(B4 * 0.687, 2);
    const D5 = round(B5 * 0.687, 2);

    const B10 = round(D4 * B9, 2);

    const D10 = (D7===0) ? "錯誤" : fmt(B10 / D7, 2);
    const D11 = (D7===0) ? "錯誤" : `${Math.floor(B10 / D7)} 包 +${round(mod(B10, D7),1)}公斤`;

    const B12 = (mode==="追總量") ? round((B5===0?0:(B10 / B5)), 2) : round(B9 * 0.687, 2);

    const D15 = round(B10 + Math.max(0, B15 - B12) * B16, 2);
    const D16 = round(B10 + (B15 - B12) * B16, 2);

    const D19 = round(B19 * 0.687, 2);
    const D20 = round(B9 * D19, 2);

    const B25 = (B19===0) ? 0 : round(B20 / B19, 2);
    const D25 = round(B20 - D20, 2);

    const B26 = B12;
    const D26 = round(B12 - B25, 2);
    const D27 = round(D26 / 0.687, 2);

    const B34 = round(B5 - B22, 2);
    const D34 = round(B34 * 0.687, 2);
    const B35 = round(B10 - B23, 2);
    const D35 = bagsText(B35, D7);

    const B36 = (B34>0) ? round((mode==="追總量" ? (B35 / B34) : B12), 2) : 0;

    const D36 = round(B34 * 0.687 * B9, 2);
    const B37 = (mode==="追總量") ? B35 : D36;
    const D37 = bagsText(B37, D7);

    const B39 = (B19===0) ? 0 : round(D20 / B19, 2);
    const D39 = round(B5 * B39, 2);

    if($("FERT_SHOW")) $("FERT_SHOW").textContent = fertName;
    $("D4").textContent = fmt(D4, 2);
    $("D5").textContent = fmt(D5, 2);

    $("B10").textContent = fmt(B10, 2);
    $("D10").textContent = D10;
    $("D11").textContent = D11;

    $("B12").textContent = fmt(B12, 2);

    $("D15").textContent = fmt(D15, 2);
    $("D16").textContent = fmt(D16, 2);

    $("D19").textContent = fmt(D19, 2);
    $("D20").textContent = fmt(D20, 2);

    $("B25").textContent = fmt(B25, 2);
    $("D25").textContent = fmt(D25, 2);

    $("B26").textContent = fmt(B26, 2);
    $("D26").textContent = fmt(D26, 2);
    $("D27").textContent = fmt(D27, 2);

    $("B34").textContent = fmt(B34, 2);
    $("D34").textContent = fmt(D34, 2);
    $("B35").textContent = fmt(B35, 2);
    $("D35").textContent = D35;

    $("B36").textContent = fmt(B36, 2);
    $("D36").textContent = fmt(D36, 2);

    $("B37").textContent = fmt(B37, 2);
    $("D37").textContent = D37;

    $("B39").textContent = fmt(B39, 2);
    $("D39").textContent = fmt(D39, 2);

    if(B35 < 0) $("B35").classList.add("danger");
    else $("B35").classList.remove("danger");
  }

  // ===== Bind events =====
  inputs.forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", ()=>{ compute(); saveLast(); });
    el.addEventListener("change", ()=>{ compute(); saveLast(); });
  });

  if($("autoLoadLast")){
    $("autoLoadLast").addEventListener("change", saveLast);
  }

  $("btnReset").addEventListener("click", ()=>{
    setInputs(defaults);
    refreshFertSelect();
    compute();
    saveLast();
  });

  $("btnCopy").addEventListener("click", async ()=>{
    const mode = $("D12").value;
    const text =
`【無人機施肥計算摘要】
模式：${mode}
地塊面積(畝)：${$("B4").value}；作業面積(畝)：${$("B5").value}
每分用量(kg)：${$("B9").value}；每包(kg)：${$("D7").value}

施肥總公斤數：${$("B10").textContent}
播撒畝用量(B12)：${$("B12").textContent}
下次建議畝用量(B36)：${$("B36").textContent}

剩餘面積(畝)：${$("B34").textContent}
剩餘應撒(kg)：${$("B37").textContent}
剩餘包數：${$("D37").textContent}`;
    try{
      await navigator.clipboard.writeText(text);
      alert("已複製到剪貼簿");
    }catch(e){
      alert("無法自動複製，請手動選取複製。\n\n"+text);
    }
  });

  // ===== Preset UI handlers =====
  ensureDefaultPresets();
  refreshFertSelect();
  refreshPresetSelect();

  $("btnLoadPreset").addEventListener("click", ()=>{
    const key = $("presetSelect").value;
    const presets = loadPresets();
    if(!key || !presets[key]){ alert("沒有可載入的預設"); return; }
    const item = presets[key];
    const data = (item && item.data) ? item.data : item;
    applyInputs(data);
    if(item && item.meta){
      item.meta.last_used = new Date().toISOString();
      item.meta.use_count = (item.meta.use_count||0) + 1;
      presets[key] = item;
      savePresets(presets);
      refreshPresetSelect(key);
    }
    compute();
    saveLast();
    alert(`已載入：${key}`);
  });

  $("btnSavePreset").addEventListener("click", ()=>{
    const nameRaw = ($("presetName").value || "").trim();
    const ts = makeTimestampKey();
    const base = nameRaw || $("presetSelect").value || `預設`;
    const key = `${base}_${ts}`;
    const presets = loadPresets();
    presets[key] = {data:getAllInputs(), meta:{created_at:new Date().toISOString(), last_used:null, use_count:0}};
    savePresets(presets);
    refreshPresetSelect(key);
    $("presetName").value = "";
    saveLast();
    alert(`已儲存：${key}`);
  });

  $("btnDeletePreset").addEventListener("click", ()=>{
    const key = $("presetSelect").value;
    const presets = loadPresets();
    if(!key || !presets[key]){ alert("沒有可刪除的預設"); return; }
    if(!confirm(`確定刪除「${key}」？`)) return;
    delete presets[key];
    savePresets(presets);
    refreshPresetSelect();
    alert("已刪除");
  });

  $("btnExportPreset").addEventListener("click", async ()=>{
    const key = $("presetSelect").value;
    const presets = loadPresets();
    if(!key || !presets[key]){ alert("沒有可匯出的預設"); return; }
    const payload = JSON.stringify({name:key, item:presets[key]}, null, 2);
    try{
      await navigator.clipboard.writeText(payload);
      alert("已複製 JSON 到剪貼簿（可貼到另一支手機匯入）");
    }catch(e){
      alert("無法自動複製，請手動複製以下內容：\n\n"+payload);
    }
  });

  $("btnImportPreset").addEventListener("click", ()=>{
    const txt = prompt("請貼上先前匯出的 JSON：");
    if(!txt) return;
    try{
      const obj = JSON.parse(txt);
      const name = (obj.name || "").toString().trim() || `匯入-${new Date().toLocaleString("zh-Hant")}`;
      const item = obj.item || obj;
      const data = item.data || item;
      const presets = loadPresets();
      presets[name] = item.data ? item : {data};
      savePresets(presets);
      refreshPresetSelect(name);
      alert(`已匯入：${name}`);
    }catch(e){
      alert("JSON 解析失敗，請確認格式正確。");
    }
  });

  $("btnQuickSavePlot").addEventListener("click", ()=>{
    const ts = makeTimestampKey();
    const area = ($("B4")?.value ?? "").toString();
    const fert = getFertName();
    const key = `地塊${area}畝_${fert}_${ts}`;
    const presets = loadPresets();
    presets[key] = {data:getAllInputs(), meta:{created_at:new Date().toISOString(), last_used:null, use_count:0}};
    savePresets(presets);
    refreshPresetSelect(key);
    $("presetName").value = "";
    saveLast();
    alert(`已儲存：${key}`);
  });

  $("btnLoadLast").addEventListener("click", ()=>{
    const ok = loadLastIfAny();
    compute();
    alert(ok ? "已載入上次設定" : "尚未有上次設定可載入");
  });

  $("btnExportFile").addEventListener("click", ()=>{
    const presets = loadPresets();
    const payload = {exported_at:new Date().toISOString(), presets, fert_list: loadFertList() || defaultFertList()};
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `fertcalc_presets_backup_${makeTimestampKey()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  // init
  const auto = $("autoLoadLast") ? $("autoLoadLast").checked : true;
  if(auto){
    loadLastIfAny();
  }
  // ★★★ 請插入這段程式碼 (開始) ★★★
  // 點擊輸入框時自動全選，方便直接打字修改，不用一直按 Backspace
  document.querySelectorAll("input[type='number']").forEach(el => {
    el.addEventListener("click", function() {
      this.select();
    });
  });
  // ★★★ 請插入這段程式碼 (結束) ★★★
  
  compute();
})();
</script>
</body>
</html>
